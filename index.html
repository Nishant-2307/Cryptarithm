<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cryptarithm Dark Mode</title>
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
:root {
  /* --- DARK THEME VARIABLES --- */
  --bg-app: #0B1120;       /* Very Dark Blue/Black */
  --bg-panel: #1E293B;     /* Slate 800 */
  --bg-input: #0F172A;     /* Slate 900 */
  
  --border-color: #334155; /* Slate 700 */
  
  --text-primary: #F8FAFC; /* White/Slate 50 */
  --text-secondary: #94A3B8; /* Slate 400 */
  --text-muted: #64748B;   /* Slate 500 */
  
  /* Accents */
  --primary: #6366F1;      /* Indigo 500 */
  --primary-hover: #4F46E5;
  
  --accent-success: #10B981; /* Emerald 500 */
  --accent-warning: #FBBF24; /* Amber 400 */
  --accent-danger: #F87171;  /* Red 400 */
  
  --code-bg: #0F172A;      /* Slate 900 */
  
  --radius: 8px;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
}

* { box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background-color: var(--bg-app);
  color: var(--text-primary);
  margin: 0;
  padding: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* --- 1. TOP NAVIGATION --- */
nav {
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border-color);
  height: 64px;
  padding: 0 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  z-index: 20;
}

.brand {
  font-weight: 700;
  font-size: 18px;
  color: var(--text-primary);
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.brand span { color: var(--primary); text-shadow: 0 0 10px rgba(99, 102, 241, 0.4); }

.controls-bar {
  display: flex;
  gap: 12px;
  align-items: center;
}

/* Input Styling */
.input-group {
  display: flex;
  align-items: center;
  background: var(--bg-input);
  padding: 4px 12px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
}
.input-group label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  margin-right: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
input[type="text"] {
  background: transparent;
  border: none;
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  color: var(--text-primary);
  width: 130px;
  outline: none;
}
input[type="text"]:focus { color: var(--primary); }

/* Buttons */
.btn {
  height: 36px;
  padding: 0 16px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border-color);
  background: var(--bg-panel);
  color: var(--text-primary);
  transition: all 0.2s;
}
.btn:hover:not(:disabled) { background: #334155; border-color: #475569; }
.btn-primary {
  background: var(--primary);
  color: white;
  border: none;
}
.btn-primary:hover:not(:disabled) { background: var(--primary-hover); box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* Checkbox */
.checkbox-wrapper {
  font-size: 13px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
}

/* --- 2. MAIN LAYOUT --- */
.main-grid {
  display: grid;
  grid-template-columns: 350px 1fr; /* Sidebar Width | Graph Width */
  grid-template-rows: 1fr 340px;    /* Top Height | Bottom Height */
  height: calc(100vh - 64px);
  overflow: hidden;
}

/* --- Panel Common Styles --- */
.panel {
  background: var(--bg-panel);
  border-right: 1px solid var(--border-color);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
}

.panel-header {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-color);
  background: rgba(0,0,0,0.2);
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  flex-shrink: 0;
}

/* --- LEFT SIDEBAR (STATE) --- */
.sidebar-content {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.equation-container {
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 160px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}

#equation {
  font-family: 'JetBrains Mono', monospace;
  font-size: 26px;
  line-height: 1.5;
  white-space: pre;
  text-align: right;
  color: var(--text-secondary);
  font-weight: 500;
}

.digit-assigned { color: var(--primary); font-weight: 700; text-shadow: 0 0 8px rgba(99, 102, 241, 0.3); }
.solved-digit { color: var(--accent-success); font-weight: 700; }
.failed-digit { color: var(--accent-danger); font-weight: 700; }

.list-section h4 {
  margin: 0 0 10px 0;
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
}
.chip {
  display: inline-block;
  background: var(--bg-input);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 13px;
  font-family: 'JetBrains Mono', monospace;
  margin: 3px;
}

/* --- CENTER (GRAPH) --- */
#graphContainer {
  width: 100%;
  height: 100%;
  background: #0B1120;
}

.graph-controls {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-panel);
  padding: 10px 20px;
  border-radius: 30px;
  border: 1px solid var(--border-color);
  box-shadow: 0 10px 25px rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  gap: 16px;
  z-index: 10;
}

input[type="range"] {
  width: 220px;
  height: 4px;
  background: var(--border-color);
  border-radius: 2px;
  -webkit-appearance: none;
  outline: none;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  background: var(--primary);
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid var(--text-primary);
  box-shadow: 0 0 10px var(--primary);
}

.legend {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(30, 41, 59, 0.9);
  padding: 12px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-size: 12px;
  color: var(--text-secondary);
  backdrop-filter: blur(4px);
}
.legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.dot { width: 10px; height: 10px; border-radius: 50%; }

/* --- BOTTOM (DEBUGGER) --- */
.debugger-row {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  height: 100%;
  border-top: 1px solid var(--border-color);
}

.code-panel {
  background: var(--code-bg);
  padding: 15px;
  overflow-y: auto;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.8; /* Increased spacing for readability */
}
.code-line { display: block; padding-left: 12px; border-left: 3px solid transparent; opacity: 0.6; }
.code-highlight {
  background: rgba(99, 102, 241, 0.15);
  border-left-color: var(--primary);
  color: var(--text-primary);
  opacity: 1;
  font-weight: 700;
}

.log-panel {
  background: var(--bg-panel);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  padding: 0;
  overflow-y: auto;
}
.log-entry {
  padding: 6px 12px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--text-secondary);
}
.log-entry:hover { background: rgba(255,255,255,0.02); }

.log-ASSIGN { color: var(--accent-success); }
.log-UNASSIGN { color: var(--primary); }
.log-AC3_PRUNE { color: var(--accent-warning); }
.log-FAIL { color: var(--accent-danger); }

</style>
</head>
<body>

<nav>
  <div class="brand">
    <span>⚡</span> CRYPTARITHM
  </div>
  
  <div class="controls-bar">
    <div class="input-group">
      <label>Equation</label>
      <input id="word1" type="text" value="CROSS" style="width: 80px; text-align: center;">
      
      <span style="color:var(--text-muted); margin:0 6px; font-weight:bold;">+</span>
      
      <input id="word2" type="text" value="ROADS" style="width: 80px; text-align: center;">
      
      <span style="color:var(--text-muted); margin:0 6px; font-weight:bold;">=</span>
      
      <input id="result" type="text" value="DANGER" style="width: 80px; text-align: center;">
    </div>
    
    <div class="checkbox-wrapper">
      <input type="checkbox" id="use_ac3" checked> 
      <label for="use_ac3" style="margin:0; font-size:12px; font-weight:600;">AC-3</label>
    </div>

    <div style="width:1px; height:24px; background:var(--border-color); margin:0 8px;"></div>

    <button id="solveBtn" class="btn btn-primary">Solve</button>
    <button id="clearBtn" class="btn">Clear</button>
    <span id="statusText" style="font-size:12px; color:var(--text-muted); width:70px; text-align:right;">Idle</span>
  </div>
</nav>

<div class="main-grid">
  
  <div class="panel">
    <div class="panel-header">Current State</div>
    <div class="sidebar-content">
      
      <div class="equation-container">
        <div id="equation"></div>
      </div>
      
      <div class="list-section">
        <h4>Assignments</h4>
        <div id="assign" style="min-height:40px; color:var(--text-secondary); font-style:italic;">None</div>
      </div>

      <div class="list-section">
        <h4>Variable Domains</h4>
        <div id="domains" style="font-size:12px; color:var(--text-muted);">Waiting for solver...</div>
      </div>
    </div>
  </div>

  <div class="panel">
    
    <div class="legend">
      <div class="legend-item"><div class="dot" style="background:#334155"></div> Root</div>
      <div class="legend-item"><div class="dot" style="background:#FBBF24"></div> Current</div>
      <div class="legend-item"><div class="dot" style="background:#10B981"></div> Path/Soln</div>
      <div class="legend-item"><div class="dot" style="background:#F87171"></div> Backtrack</div>
    </div>
    
    <div id="graphContainer"></div>

    <div class="graph-controls">
      <button id="startEqBtn" class="btn" style="height:30px; padding:0 12px; border:none; background:#334155;">▶</button>
      <button id="pauseEqBtn" class="btn" style="height:30px; padding:0 12px; border:none; background:#334155;" disabled>⏸</button>
      <input type="range" id="progressEq" value="0" min="0" max="100">
      <span id="posEq" style="font-size:12px; font-family:'JetBrains Mono'; color:var(--text-primary); width:50px;">0/0</span>
      <div style="width:1px; height:20px; background:var(--border-color);"></div>
      <input id="speedEq" type="number" value="50" style="width:40px; background:transparent; border:none; color:var(--text-primary); font-size:12px; text-align:center;">
      <span style="font-size:10px; color:var(--text-muted);">ms</span>
    </div>
  </div>

  <div class="debugger-row">
    
    <div class="panel" style="border-bottom:none;">
      <div class="panel-header">Algorithm Logic (Pseudocode)</div>
      <div id="codePanel" class="code-panel">
        <span class="code-line" id="line-1">def backtrack(assignment, domains):</span>
        <span class="code-line" id="line-2">&nbsp;&nbsp;# 1. Check Goal</span>
        <span class="code-line" id="line-3">&nbsp;&nbsp;if len(assignment) == len(variables):</span>
        <span class="code-line" id="line-4">&nbsp;&nbsp;&nbsp;&nbsp;return check_constraints() ? SOLUTION : None</span>
        <span class="code-line" id="line-5"></span>
        <span class="code-line" id="line-6">&nbsp;&nbsp;# 2. Select Var (MRV Heuristic)</span>
        <span class="code-line" id="line-7">&nbsp;&nbsp;var = select_unassigned_var(domains)</span>
        <span class="code-line" id="line-8"></span>
        <span class="code-line" id="line-9">&nbsp;&nbsp;# 3. Try Values in Domain</span>
        <span class="code-line" id="line-10">&nbsp;&nbsp;for val in sorted(domains[var]):</span>
        <span class="code-line" id="line-11">&nbsp;&nbsp;&nbsp;&nbsp;assign(var, val)</span>
        <span class="code-line" id="line-12"></span>
        <span class="code-line" id="line-13">&nbsp;&nbsp;&nbsp;&nbsp;# 4. Inference (Forward Check / AC-3)</span>
        <span class="code-line" id="line-14">&nbsp;&nbsp;&nbsp;&nbsp;if is_consistent(domains):</span>
        <span class="code-line" id="line-15">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if backtrack(assignment, domains): return SOLUTION</span>
        <span class="code-line" id="line-16"></span>
        <span class="code-line" id="line-17">&nbsp;&nbsp;&nbsp;&nbsp;# 5. Backtrack</span>
        <span class="code-line" id="line-18">&nbsp;&nbsp;&nbsp;&nbsp;unassign(var); restore_domains()</span>
        <span class="code-line" id="line-19"></span>
        <span class="code-line" id="line-20">&nbsp;&nbsp;return None</span>
      </div>
    </div>

    <div class="panel" style="border-right:none; border-bottom:none;">
      <div class="panel-header">Execution Log</div>
      <div id="log" class="log-panel"></div>
    </div>
  </div>

</div>

<script>
// --- CORE VARS ---
const el = (id) => document.getElementById(id);
let events = [];
let eqIdx = 0;
let eqTimer = null;
let lastAssignment = {}, lastDomains = {};
let currentWords = [], currentResult = "";
let isSolved = false, isFailed = false;
let network = null, nodes = null, edges = null;
let searchTree = { nodes: [], edges: [], nodeMap: {}, eventToNodeMap: [] };
let nodeIdCounter = 0, nodeStack = [];

// --- 1. GRAPH BUILDER ---
function buildSearchTreeFromEvents(events) {
  searchTree = { nodes: [], edges: [], nodeMap: {}, eventToNodeMap: [] };
  nodeIdCounter = 0; nodeStack = [];
  
  const rootId = nodeIdCounter++;
  const rootNode = { 
    id: rootId, label: 'ROOT', level: 0, assignment: {}, 
    color: { background: '#1E293B', border: '#475569' },
    font: { color: '#94A3B8' },
    isSolution: false // Track solution status
  };
  searchTree.nodes.push(rootNode);
  searchTree.nodeMap[rootId] = rootNode;
  nodeStack.push(rootId);

  let currentLevel = 0;

  for (let i = 0; i < events.length; i++) {
    const e = events[i];
    searchTree.eventToNodeMap[i] = [...nodeStack];

    if (e.type === 'ASSIGN') {
      const parentId = nodeStack[nodeStack.length - 1];
      const newAssign = { ...searchTree.nodeMap[parentId].assignment, [e.var]: e.value };
      const label = `${e.var}=${e.value}`;
      
      const newNodeId = nodeIdCounter++;
      const newNode = {
        id: newNodeId,
        label: label,
        level: currentLevel + 1,
        assignment: newAssign,
        color: { background: '#312E81', border: '#6366F1' },
        font: { color: '#E0E7FF' },
        isSolution: false
      };
      searchTree.nodes.push(newNode);
      searchTree.nodeMap[newNodeId] = newNode;
      searchTree.edges.push({ from: parentId, to: newNodeId, arrows: 'to', color: { color: '#475569' } });
      nodeStack.push(newNodeId);
      currentLevel++;

    } else if (e.type === 'UNASSIGN') {
      if (nodeStack.length > 1) {
        const deadId = nodeStack.pop();
        searchTree.nodeMap[deadId].color = { background: '#450A0A', border: '#F87171' };
        searchTree.nodeMap[deadId].font = { color: '#FECACA' };
        currentLevel--;
      }
    } else if (e.type === 'END' && e.result) {
       // MARK SOLUTION NODES
       nodeStack.forEach(nid => {
         searchTree.nodeMap[nid].isSolution = true; // Tag as solution
         // Set default static color to Green
         searchTree.nodeMap[nid].color = { background: '#064E3B', border: '#10B981' };
         searchTree.nodeMap[nid].font = { color: '#D1FAE5' };
       });
    }
  }
  return searchTree;
}

function initializeSearchTree() {
  if (!events.length) return;
  const tree = buildSearchTreeFromEvents(events);
  nodes = new vis.DataSet(tree.nodes);
  edges = new vis.DataSet(tree.edges);
  const container = el('graphContainer');
  const data = { nodes, edges };
  const options = {
    layout: { hierarchical: { direction: 'UD', sortMethod: 'directed', nodeSpacing: 100, levelSeparation: 80 } },
    physics: { enabled: false },
    interaction: { dragNodes: false, zoomView: true },
    nodes: { shape: 'box', margin: 8, font: { face: 'JetBrains Mono', size: 12 }, borderWidth: 1, shadow: false },
    edges: { smooth: { type: 'cubicBezier', roundness: 0.5 }, width: 1 }
  };
  if (network) network.destroy();
  network = new vis.Network(container, data, options);
}

function highlightCurrentNode(idx) {
  if (!nodes || idx >= searchTree.eventToNodeMap.length) return;
  const stack = searchTree.eventToNodeMap[idx];
  if (!stack) return;

  // Reset colors if restarting
  if(idx === 0) {
      Object.values(searchTree.nodeMap).forEach(n => {
         const isRoot = n.id===0;
         const baseColor = isRoot ? {background:'#1E293B', border:'#475569'} : {background:'#312E81', border:'#6366F1'};
         nodes.update({ id:n.id, color: baseColor });
      });
  }

  stack.forEach((nid, i) => {
    const isHead = (i === stack.length - 1);
    const nodeDef = searchTree.nodeMap[nid];

    if (nodeDef.isSolution) {
      // FORCE GREEN FOR SOLUTION NODES (Even if it's the head/current node)
      nodes.update({ id: nid, color: { background: '#064E3B', border: '#10B981' }, font: { color: '#D1FAE5' } });
      if (isHead && network) network.focus(nid, { scale: 1.0, animation: { duration: 200 } });
    } 
    else {
      // Normal Logic for non-solution nodes
      if (isHead) {
        // Current Scanner: Amber Glow
        nodes.update({ id: nid, color: { background: '#B45309', border: '#FBBF24' }, font:{color:'#FFFBEB'} });
        if (network) network.focus(nid, { scale: 1.0, animation: { duration: 200 } });
      } else if (nid !== 0) {
        // Traversed Path: Dark Green Tint
        nodes.update({ id: nid, color: { background: '#065F46', border: '#34D399' } }); 
      }
    }
  });
}

// --- 2. DISPLAY LOGIC ---
function highlightLine(id) {
  document.querySelectorAll('.code-line').forEach(e => e.classList.remove('code-highlight'));
  const line = el(id);
  if (line) {
      line.classList.add('code-highlight');
      line.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function renderEquation(words, result, assign) {
  const all = [...words, result];
  const maxLen = Math.max(...all.map(w => w.length));
  const pad = w => w.padStart(maxLen, " ");

  let lines = words.map((w, i) => {
      const prefix = (i === words.length - 1) ? "+ " : "  ";
      return prefix + pad(w);
  });
  lines.push("-".repeat(maxLen + 2));
  lines.push("= " + pad(result));

  let html = lines.join("\n").replace(/[A-Z]/g, ch => {
    if (assign[ch] !== undefined) {
      const cls = isFailed ? "failed-digit" : (isSolved ? "solved-digit" : "digit-assigned");
      return `<span class="${cls}">${assign[ch]}</span>`;
    }
    return `<span style="opacity:0.3">${ch}</span>`;
  });
  el("equation").innerHTML = html;
}

function formatEvent(e) {
  if (e.type === 'ASSIGN') return `<span class="log-ASSIGN">ASSIGN</span> ${e.var} = ${e.value}`;
  if (e.type === 'UNASSIGN') return `<span class="log-UNASSIGN">BACKTRACK</span> ${e.var}`;
  if (e.type === 'AC3_PRUNE') return `<span class="log-AC3_PRUNE">PRUNE</span> ${e.var}`;
  if (e.type === 'START') return `Started solving...`;
  if (e.type === 'END') return e.result ? `<span style="color:#34D399">SUCCESS</span>` : `<span class="log-FAIL">FAILED</span>`;
  return e.type;
}

function renderEvent() {
  if (eqIdx >= events.length) return;
  const e = events[eqIdx];

  // --- LOGIC HIGHLIGHTING MAPPING (Reflected from solver.py) ---
  if (e.type === "START") highlightLine("line-1");
  else if (e.type === "CURRENT_ASSIGNMENT") highlightLine("line-3"); // Check Goal
  else if (e.type === "ASSIGN") highlightLine("line-11"); // Assign
  else if (e.type === "AC3_PRUNE") highlightLine("line-14"); // Inference
  else if (e.type === "UNASSIGN") highlightLine("line-18"); // Backtrack
  else if (e.type === "END") highlightLine(e.result ? "line-4" : "line-20"); // Return
  else highlightLine("line-7"); // Select Var (default)

  if (e.assignment) lastAssignment = e.assignment;
  if (e.domains) lastDomains = e.domains;
  if (e.type === "END" && e.result) isSolved = true;
  if (e.type === "END" && !e.result) isFailed = true;

  el("assign").innerHTML = Object.entries(lastAssignment).length ? 
    Object.entries(lastAssignment).map(([k,v]) => `<span class="chip">${k}:${v}</span>`).join('') : 
    `<i>None</i>`;
  
  el("domains").innerHTML = Object.entries(lastDomains).map(([k, vals]) => 
    `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #334155; padding:4px 0;">
       <b style="color:#94A3B8">${k}</b> <span style="color:#64748B">{${vals.join(',')}}</span>
     </div>`
  ).join('');

  renderEquation(currentWords, currentResult, lastAssignment);
  
  if (!["CURRENT_ASSIGNMENT","CURRENT_DOMAINS"].includes(e.type)) {
    const div = document.createElement("div");
    div.className = "log-entry";
    div.innerHTML = `<span style="color:#475569; font-size:10px; margin-right:8px;">${eqIdx}</span> ${formatEvent(e)}`;
    el("log").appendChild(div);
    el("log").scrollTop = el("log").scrollHeight;
  }

  highlightCurrentNode(eqIdx);
  
  el("progressEq").value = eqIdx + 1;
  el("posEq").innerText = `${eqIdx + 1}/${events.length}`;
  
  eqIdx++;
}

// --- CONTROLS ---
function jumpToEvent(idx) {
  clearInterval(eqTimer); el("pauseEqBtn").disabled = true;
  eqIdx = 0; lastAssignment={}; lastDomains={}; el("log").innerHTML="";
  isSolved=false; isFailed=false;
  
  while(eqIdx < idx) {
    const e = events[eqIdx];
    if(e.assignment) lastAssignment=e.assignment;
    if(e.domains) lastDomains=e.domains;
    eqIdx++;
  }
  
  renderEquation(currentWords, currentResult, lastAssignment);
  el("assign").innerHTML = Object.entries(lastAssignment).map(([k,v])=>`<span class="chip">${k}:${v}</span>`).join('');
  el("progressEq").value = idx;
  el("posEq").innerText = `${idx}/${events.length}`;
  highlightCurrentNode(idx);
}

el("solveBtn").onclick = async () => {
  const btn = el("solveBtn");
  const status = el("statusText");
  
  // 1. READ INPUTS FROM TWO BOXES
  const w1 = el("word1").value.trim().toUpperCase();
  const w2 = el("word2").value.trim().toUpperCase();
  
  if (!w1 || !w2) return alert("Please enter both words.");
  
  currentWords = [w1, w2];
  currentResult = el("result").value.trim().toUpperCase();

  // 2. UI STATUS UPDATE
  btn.disabled = true; 
  status.innerText = "Solving...";

  // 3. SEND TO SERVER
  await fetch("/clear", {method:"POST"});
  await fetch("/solve", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ 
      words: currentWords, 
      result: currentResult, 
      use_ac3: el("use_ac3").checked 
    })
  });

  // 4. POLL FOR TRACE
  const poll = setInterval(async () => {
    try {
      const r = await (await fetch("/trace")).json();
      if (r.ready) {
        clearInterval(poll);
        events = r.events;
        status.innerText = `Ready (${events.length})`;
        btn.disabled = false;
        el("progressEq").max = events.length;
        initializeSearchTree();
        jumpToEvent(0);
      }
    } catch(e) {}
  }, 800);
};

el("startEqBtn").onclick = () => {
  if(!events.length) return;
  const speed = parseInt(el("speedEq").value);
  eqTimer = setInterval(() => {
    if(eqIdx < events.length) renderEvent(); else clearInterval(eqTimer);
  }, speed);
  el("pauseEqBtn").disabled = false;
};
el("pauseEqBtn").onclick = () => { clearInterval(eqTimer); el("pauseEqBtn").disabled = true; };
el("progressEq").oninput = (e) => jumpToEvent(parseInt(e.target.value));
el("clearBtn").onclick = async () => { await fetch("/clear", {method:"POST"}); location.reload(); };

</script>
</body>
</html>